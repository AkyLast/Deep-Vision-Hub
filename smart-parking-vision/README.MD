# üöó Smart Parking Vision

![Build](https://img.shields.io/badge/build-passing-brightgreen) ![Python](https://img.shields.io/badge/python-3.10-blue) ![License](https://img.shields.io/badge/license-MIT-green)

## TL;DR

Sistema de vis√£o computacional que detecta ocupa√ß√£o de vagas em v√≠deos usando ROIs (Regi√µes de Interesse). Realiza pr√©-processamento, conta pixels brancos por ROI e sincroniza estados com uma API REST local. Feito para demonstrar compet√™ncias pr√°ticas em OpenCV, integra√ß√£o cliente/servidor e engenharia de dados.

---

## üìë √çndice

1. [Sobre o Projeto](#sobre-o-projeto)
2. [Demonstra√ß√£o](#demonstra√ß√£o)
3. [Arquitetura](#arquitetura)
4. [Tecnologias](#tecnologias)
5. [Configura√ß√£o (`config.json`)](#configura√ß√£o-configjson)
6. [Configura√ß√£o (`main.py`)](#configura√ß√£o-mainpy)
6. [Execu√ß√£o](#execu√ß√£o)
7. [Como funciona (t√©cnico)](#como-funciona-t√©cnico)
8. [Exemplos de C√≥digo](#exemplos-de-c√≥digo)
9. [Logs e Persist√™ncia](#logs-e-persist√™ncia)
10. [Revis√µes / Bugs encontrados & Corre√ß√µes sugeridas](#revis√µes--bugs-encontrados--corre√ß√µes-sugeridas)
11. [Melhorias sugeridas / Roadmap](#melhorias-sugeridas--roadmap)
12. [Contribui√ß√£o](#contribui√ß√£o)
13. [Licen√ßa](#licen√ßa)
14. [Contato](#contato)

---

## Sobre o Projeto

**Problema:** monitoramento de vagas em estacionamentos/condom√≠nios usando c√¢meras existentes.

**Solu√ß√£o:** processamento de v√≠deo por ROI para determinar ocupa√ß√£o e sincronizar com API local. Projeto pensado para demonstrar habilidades t√©cnicas valorizadas por recrutadores: OpenCV, Python, integra√ß√£o REST, manipula√ß√£o de configs, logging e estrutura de projeto.

**Finalidade:** este sistema n√£o √© apenas uma demonstra√ß√£o t√©cnica, mas uma solu√ß√£o estrat√©gica para quem busca transformar a gest√£o de estacionamentos em um processo **mais inteligente, eficiente e lucrativo**. Com ele, √© poss√≠vel utilizar c√¢meras j√° existentes, eliminando altos custos de hardware, e obter em tempo real o status das vagas dispon√≠veis. Isso permite desde a **redu√ß√£o de filas e aumento da satisfa√ß√£o dos clientes**, at√© a **otimiza√ß√£o da ocupa√ß√£o e gera√ß√£o de insights valiosos para decis√µes de neg√≥cio**. Em condom√≠nios, shoppings ou empresas, o diferencial est√° na **automatiza√ß√£o acess√≠vel**, que agrega valor imediato sem demandar grandes mudan√ßas na infraestrutura atual.

---

## Demonstra√ß√£o

![demo](Sources/output.gif)


---

## Arquitetura (resumo)

* **main.py** ‚Äî cliente de processamento de v√≠deo: carrega `config.json`, pr√©-processa frames, avalia ROIs (classe `AnalyzeSpace`) e atualiza API.
* **server/app.py** ‚Äî API Flask: endpoints para criar vagas, retornar status e atualizar vagas.
* **models/roi_analyzer.py** ‚Äî l√≥gica de contagem, desenho e debounce (`StatusRois`, `AnalyzeSpace`).
* **utils/** ‚Äî `connection.py` (integra√ß√£o com API), `save_logs.py` (salva logs em Excel).
* **config.json** ‚Äî centraliza v√≠deos, ROIs, par√¢metros de dilate e √°rea de contagem.

Fluxo: V√≠deo ‚Üí pr√©-processamento ‚Üí contagem por ROI ‚Üí debounce ‚Üí PATCH API ‚Üí logs.

---

## Tecnologias

* Python 3.13 (recomendado)
* OpenCV (`opencv-python`)
* NumPy
* Flask
* Requests
* Pandas + openpyxl (logs Excel)

---

## Configura√ß√£o (`config.json`)
Onde est√° 0 ou 1 √© para disativar ou ativar determinadas fun√ß√µes.

Arquivo central que cont√©m:

* `status_server` ‚Äî Status para o processamento ser interno(0) ou no servidor(1).
* `videos_config.video_colored.video_path` ‚Äî lista de paths dos v√≠deos (ex.: `"Sources/shoppingPark.mp4"` ou `0`, `1`, ... para expecificar a entrada de v√≠deo do seu computador).
* `rois` ‚Äî dicion√°rio por estacionamento com listas de ROIs: `{ "id_roi", "x","y","w","h","threshold" }`.
* `dilate` ‚Äî `kernel` e `iterations` por estacionamento.
* `counting_area_config` ‚Äî local do placar/contador na imagem.
* `logs_path` ‚Äî caminho do arquivo Excel para logs.

**Aten√ß√£o:** Paths no JSON s√£o relativos √† raiz do projeto. Ajuste caso execute de outra pasta.

---

## Configura√ß√£o (`main.py`)
No tocante, as contastes n√£o precisam se preocupar com as atera√ß√µes, apenas com a diferencial da vari√°vel `VIDEOS_PATH`. Teremos que adicionar o √≠ndice do v√≠deo/entrada de v√≠deos na qual queremos acessar.

A Vari√°vel `VIDEOS_PATH` est√° intriscicamente ligada com o objeto "videos_config" do `.json`, em expec√≠fico, diretamente ligada com o `"video_path`

```json
"videos_config": {
        "video_colored": {"video_path": ["Sources/condPark.mp4", "Sources/shoppingPark.mp4", 0], "size": [1280, 720], "statusDraw_Counter": 1, "statusDraw_idVaga": 1},
        "video_grayscaled": {"status": 0, "size": [550, 360]}
    }
``` 

Exemplo:
```python
   VIDEOS_PATH = VIDEOS_CONFIG["video_colored"]["video_path"][0]  # Primeira vari√°vel do "video_path" no .json -> "Sources/condPark.mp4"
   VIDEOS_PATH = VIDEOS_CONFIG["video_colored"]["video_path"][1]  # Segunda vari√°vel do "video_path" no .json -> "Sources/shoppingPark.mp4"
   VIDEOS_PATH = VIDEOS_CONFIG["video_colored"]["video_path"][2]  # Terceira vari√°vel do "video_path" no .json -> "0", C√¢mera do computador
```
---

## Execu√ß√£o

1. Inicie a API (servidor local):

```bash
python server/app.py
# padr√£o: http://127.0.0.1:5000
```

2. Em outro terminal, execute o processamento:

```bash
python main.py
```

* Pressione `q` enquanto a janela do OpenCV estiver em foco para interromper.
* `main.py` chama `utils.connection.set_parking` ao iniciar para registrar as vagas no servidor.

---

## Como funciona (t√©cnico)

1. **Leitura de frame**: `cv2.VideoCapture` ‚Üí `ret, img`.
2. **Pr√©-processamento**:

   * `cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)` (recomendado)
   * `cv2.GaussianBlur` para reduzir ru√≠do
   * `cv2.adaptiveThreshold(..., cv2.THRESH_BINARY_INV, ...)`
   * `cv2.dilate` com `kernel` configurado
3. **Para cada ROI**:

   * recorta regi√£o: `frame[y:y+h, x:x+w]`
   * `cv2.countNonZero` para contar pixels brancos
   * compara com `threshold` definido no JSON
   * usa `StatusRois` para debounce (limiter de N frames antes de confirmar mudan√ßa)
4. **Desenho**: ret√¢ngulos coloridos (verde/laranja/vermelho), contadores e ID da vaga.
5. **Sincroniza√ß√£o**: quando o estado √© confirmado, chama `PATCH /parking/<parking>/<id>` para atualizar o status no servidor.
6. **Logs**: `utils/save_logs.py` escreve eventos em Excel (`Sources/dados.xlsx`).

---

## Exemplos de C√≥digo (trechos retirados do projeto)

Trecho de pr√©-processamento em `main.py`:

```python
img_gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY) 
gaussian_gray = cv2.GaussianBlur(img_gray, (9, 9), 1)
img_th = cv2.adaptiveThreshold(
    gaussian_gray, 255, cv2.ADAPTIVE_THRESH_MEAN_C, cv2.THRESH_BINARY_INV, 11, 12
)
kernel = np.ones(DILATE["kernel"], dtype=np.uint8)
imgDil = cv2.dilate(img_th, kernel, iterations=DILATE["iterations"])
```

Contagem por ROI (`models/roi_analyzer.py`):

```python
def count_white(self):
    cutted = self.frame[self.y: self.y + self.h, self.x: self.x + self.w]
    count = cv2.countNonZero(cutted)
    return count
```

Debounce simplificado (`StatusRois.analyze_roi`):

```python
def analyze_roi(self, new_status=False):
    status_update = self.status
    if self.status != new_status:
        self.limiter -= 1
        if self.limiter == 0:
            self.limiter = 5
            status_update = new_status
            update_parking(parking=self.parking, vaga_id=self.id_roi, status=status_update)
            self.status = status_update
    else:
        self.limiter = 5
    return status_update
```

---

## Logs e Persist√™ncia

* Logs s√£o armazenados em Excel conforme `config.json["logs_path"]` (ex.: `Sources/dados.xlsx`). Simulando situa√ß√µes que o uso do banco de dados seja inacess√≠vel.
* `utils/save_logs.py` cria o arquivo caso n√£o exista e registra linhas com: `DATA`, `ID_VAGA`, `ESTACIONAMENTO`, `STATUS`.

---

## Melhorias futuras / Roadmap

* **Processamento no servidor**: mover a etapa de verifica√ß√£o das vagas para o servidor, enviando apenas os resultados para os clientes. Isso reduz a carga em m√°quinas com pouco poder de processamento.
* **Modelos de Deep Learning**: implementa√ß√£o e compara√ß√£o de dois modelos para detec√ß√£o de ocupa√ß√£o ‚Äî um baseado em **PyTorch** e outro em **YOLO**, visando robustez e flexibilidade em diferentes cen√°rios.
* **Armazenamento de imagens em banco de dados**: salvar recortes de vagas e frames relevantes para criar um hist√≥rico visual, permitindo an√°lises posteriores e alimentando pipelines de melhoria cont√≠nua dos modelos.
* **Treinamento cont√≠nuo**: usar o banco de imagens coletado para refinar os modelos, adaptando o sistema a diferentes ambientes (ilumina√ß√£o, clima, √¢ngulos de c√¢mera).
* Dashboard web em tempo real (WebSocket) mostrando vagas.
* Persist√™ncia em banco + autentica√ß√£o na API.
* Testes unit√°rios (mocks para `update_parking`) e CI.
* Dockerfile + Compose (API + processor) para facilitar deploy.

---

## Contribui√ß√£o

1. Fork ‚Üí clone ‚Üí branch `feature/main`
2. Commit claros e descritivos
3. PR com descri√ß√£o, screenshots e, quando poss√≠vel, testes

---

## Licen√ßa

Este projeto usa **MIT License**. Veja `LICENSE` no reposit√≥rio.

---

## Contato

* LinkedIn: [Luis Fernando Ribeiro Curvelo](https://www.linkedin.com/in/luis-fernando-ribeiro-curvelo/)
* Email: [luisribeiro.curvelo@gmail.com](mailto:luisribeiro.curvelo@gmail.com)

---
